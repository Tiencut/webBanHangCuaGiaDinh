name: Build, Publish and Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build backend jar
        run: |
          cd web-ban-hang-gia-dinh
          ./mvnw -B -DskipTests package

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT || secrets.GITHUB_TOKEN }}

      - name: Build and push images
        run: |
          docker build -t ghcr.io/${{ github.repository }}/backend:latest -f web-ban-hang-gia-dinh/Dockerfile web-ban-hang-gia-dinh
          docker push ghcr.io/${{ github.repository }}/backend:latest
          docker build -t ghcr.io/${{ github.repository }}/frontend:latest -f FE/Dockerfile FE
          docker push ghcr.io/${{ github.repository }}/frontend:latest

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail
            REMOTE_DIR="${{ secrets.REMOTE_COMPOSE_DIR }}"
            mkdir -p "$REMOTE_DIR"
            # write remote .env to enable Raptor mini (Preview) for all clients; default to true if secret not set
            echo "ENABLE_RAPTOR_MINI=${{ secrets.ENABLE_RAPTOR_MINI || 'true' }}" > "$REMOTE_DIR/.env"
            # create remote deploy script
            cat > "$REMOTE_DIR/remote_deploy.sh" <<'EOF'
            #!/usr/bin/env bash
            set -euo pipefail
            DIR="$(dirname "$0")"
            cd "$DIR"
            echo "Pulling images..."
            docker compose pull || true
            echo "Starting containers..."
            docker compose up -d --remove-orphans
            echo "Pruning images..."
            docker image prune -f || true
            echo "Waiting for health endpoint..."
            HEALTH_URL=${HEALTH_URL:-http://localhost:8080/actuator/health}
            MAX_WAIT=${MAX_WAIT:-120}
            SLEEP_INTERVAL=${SLEEP_INTERVAL:-5}
            elapsed=0
            while [ $elapsed -lt $MAX_WAIT ]; do
              if curl -fsS "$HEALTH_URL" >/dev/null 2>&1; then
                echo "Health check passed"
                exit 0
              fi
              sleep $SLEEP_INTERVAL
              elapsed=$((elapsed + SLEEP_INTERVAL))
            done
            echo "Health check failed after ${MAX_WAIT}s" >&2
            exit 2
            EOF
            # strip leading YAML indentation so script has a correct shebang at column 1
            sed -i 's/^ \{12\}//' "$REMOTE_DIR/remote_deploy.sh"
            chmod +x "$REMOTE_DIR/remote_deploy.sh"
            # run remote deploy script (export HEALTH_URL if different)
            HEALTH_URL="${{ secrets.DEPLOY_HEALTH_URL || 'http://localhost:8080/actuator/health' }}"
            ssh_opts="-o StrictHostKeyChecking=no"
            # Execute script
            bash -lc "HEALTH_URL=$HEALTH_URL $REMOTE_DIR/remote_deploy.sh"

      - name: Done
        run: echo "Deployment finished"
